---
marp: true
---

# å®Ÿè·µ:Ethereumã‚’åˆ©ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º
## æŠ€è¡“é¸æŠãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»åœ°é›·

Masashi Salvador Mitsuzawa, Lead Engineer @ LayerX

--- 

## è‡ªå·±ç´¹ä»‹
![bg left](./images/profile.png)
### Masashi Salvador Mitsuzawa (@masashisalvador)
* Lead Engineer @ LayerX
* å¥½ããªè¨€èª:Go, JavaScript, Haskell, Kotlin
* è»¸è¶³ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
* è¶£å‘³ï¼šå±±ãƒ»èŒ¶é“ãƒ»è¨ˆç®—è«–çš„ç¥çµŒç§‘å­¦ etc

---

# è©±ã™ã“ã¨
* ç¾å®Ÿçš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
    * Web API, indexDB, indexer(ignitor)
* è¨€èªé¸æŠãƒ»å®Ÿè£…ãƒ»ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³
    * Go?
    * ã•ã‚ˆãªã‚‰web3.js....
    * æ§˜ã€…ãªä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ãŸã¡
* éª¨ã®æŠ˜ã‚Œã‚‹å®Ÿè£…
    * ç½²åæ¤œè¨¼ï¼ ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
    * ãƒ¡ã‚¿ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆçš„ãªã‚‚ã®ï¼‰
    * etc...
* ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆé–‹ç™ºç‰¹æœ‰ã®åœ°é›·ã¨å¯¾å¿œç­–

---

# ç¾å®Ÿçš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãŸã‚ã«è€ƒãˆã‚‹ã¹ãã“ã¨
* ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãŒWalletã‚’æŒã£ã¦ã„ã‚‹ä»®å®šã—ãªã„
  * ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§éµã‚’æŒã¤
  * éµã‚’ä½¿ã£ãŸèªè¨¼æ©Ÿæ§‹
* Ethereumã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¯Readã®æ©Ÿèƒ½ãŒè²§å¼±
  * åŸºæœ¬ key-valueçš„ã«ã—ã‹å¼•ã‘ãªã„
  * ä¸€è¦§å–å¾—ãƒ»æ¤œç´¢ãƒ»ãƒšãƒ¼ã‚¸ãƒ³ã‚°etc
  * ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒã‚¹ã‚¿ãƒ¼ã¨ã—ã¦åˆ¥DBã«index
* è‡ªå‹•åŸ·è¡Œï¼ˆï¼Ÿï¼‰ï¼ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•
  * ã‚¤ãƒ™ãƒ³ãƒˆã¯åã‘ã‚‹ãŒãƒãƒƒãƒçš„ãªæ©Ÿèƒ½ã¯ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ã¯ãªã„
  * ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¦‹ã‚‹ -> å‡¦ç†ã‚’kick

---
![bg 70%](images/arch.png)
![bg 80%](images/arch_node.png)

---

# ç¾å®Ÿçš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨æŠ€è¡“é¸æŠ
* ã©ã“ã¾ã§ç–çµåˆã«ã™ã‚‹ã‹
   * ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¤šã„ã¨ä½œã‚‹ã‚‚ã®ãŒç„¡é§„ã«å¢—ãˆã‚‹
* ä½•ã§ä½œã‚‹ã‹ãƒ»ä½•ã‚’ä½¿ã£ã¦ä½œã‚‹ã‹
   * Web API
   * Frontend
   * indexDBä½•ã«ã—ã‚ˆã†ï¼Ÿ(RDB? KVS?)
   * indexer, ignitorã©ã†ã—ã‚ˆã†
   * ãƒãƒ¼ãƒ‰ã¯ä½•ãŒè‰¯ã„ã ã‚ã†ï¼Ÿã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ï¼Ÿ

--- 
# ã•ã—ã‚ãŸã£ã¦Web APIã¯Goã§ä½œã‚‹ã“ã¨ã«
## @ã¨ã‚ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

---
# Goã§Ethereumã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’å©ã
* Contractã®bindingsã‚’ç”Ÿæˆã™ã‚‹ or RPCãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é ‘å¼µã£ã¦ä½œã‚‹
* gethã®ãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³ `abigen`

```
truffle compile # truffleã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç”Ÿæˆ
# jqã§ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰abiã ã‘æŠ½å‡º
for json in `ls contracts/build/contracts/*.json`; do cat $json | jq .abi > $json.abi; done;
```
abiã‹ã‚‰bindingsã‚’ç”Ÿæˆ
```
abigen --abi /home/contracts/build/contracts/TxRelay.json.abi --pkg contract --type TxRelay --out /home/tx_relay.go mv tx_relay.go api/contracts/
```

é©åˆ‡ã«Makefileã‚’æ›¸ã„ã¦åŠ¹ç‡åŒ–ã—ã¾ã™
```
make extract_abi
make abigen_all
```

---
# ç”Ÿæˆã•ã‚Œã‚‹bindings(èª­ã¿å‡ºã—/txå®Ÿè¡Œ)

![](images/code_abigen1.png)

---
# ç”Ÿæˆã•ã‚Œã‚‹bindings(ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–)
![](images/code_abigen2.png)

---
# ã„ã‘ãã†ã«è¦‹ãˆã‚‹ãŒ...
* buildãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒè‹¥å¹²é•·ã„
    * contractå¤‰æ›´ -> compile -> abigen -> go build 
* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã®gethã¯å°å›ã‚ŠãŒåŠ¹ã‹ãªã„
    * estimateGasã¨ã‹ã§ã™ã‚‰çµæ§‹ã‚„ã‚‹ã®å¤§å¤‰
* ãƒã‚¤ãƒˆåˆ—ã®æ‰±ã„ãŒå„æ‰€ã§ç•°ãªã‚Šè¾›ã„
    * "0x1234...." @ Frontend, JavaScript
    * [0x11, 0xab,...] @ Web API, Go[32]byte (prefixã®0xã¯ä¸è¦)
    * "0x1234...." @ Contract, Solidity
    * Front -> web api -> contractã§ã‚„ã‚Šå–ã‚Šã™ã‚‹åº¦ã«å¤‰æ›ãŒå¿…è¦ï¼ˆã¤ã‚‰ã™ãã‚‹ï¼‰
* ä½•ã‹ã‚„ã‚ã†ã¨ã™ã‚‹ã¨gethã‚’èª­ã¾ãªã„ã¨ã„ã‘ãªã„
    * ç°¡å˜ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼š[Ethereum Development with Go
](https://goethereumbook.org/en/)
   
---

# ã¿ãªã•ã‚“web3.jsä½¿ã£ã¦ã¾ã™ã‹ï¼Ÿ
# ã¿ãªã•ã‚“web3.jsã§ãƒãƒã£ãŸã“ã¨ãªã„ã§ã™ã‹ï¼Ÿ

--- 

# web3.jsã®ã¤ã‚‰ã¿
* ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«ç ´å£Šã•ã‚Œã‚‹å¾Œæ–¹äº’æ›æ€§
   * ã‹ã‚†ã„æ‰€ã«æ‰‹ãŒå±Šã‹ãªã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (&  çªç„¶ã®404)
* æ™®é€šã«ãƒã‚°ã£ã¦ã¦å‹•ã‹ãªã„(1.0.34 - 1.0.37ãã‚‰ã„)
    * ã‚¤ãƒ™ãƒ³ãƒˆã®subscribeå‘¨ã‚Š
    * ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ -> ã‚¤ãƒ™ãƒ³ãƒˆãŒå±¥ã‹ã‚Œã¦ã„ã‚‹ã®ç¢ºèª -> web3.jså´ãŒç„¡åå¿œ -> åŸå› æ¢ã‚‹ -> ç„¡é™ã«æ™‚é–“ãŒæº¶ã‘ã‚‹
* TypeScriptã¨ç›¸æ€§ãŒæ‚ªã„...(å‹å®šç¾©ãŒå¾®å¦™...)
* ä»–ã«ã‚‚ã„ã‚ã„ã‚...

---

# web3.jsã‚’æ¨ã¦ã¦ğŸ˜¢ethers.jsã‚’ä½¿ã†ã“ã¨ã«ğŸ˜

---
![bg 85%](images/ethersjs_ss.png)

---

![bg 85%](images/ethers_event.png)

--- 

# ethers.jsã®è‰¯ã„ã¨ã“ã‚
* ãã‚‚ãã‚‚TypeScriptã§é–‹ç™ºã•ã‚Œã¦ã„ã‚‹&å‹å®šç¾©ãŒã‚¤ã‚±ã¦ã„ã‚‹ã®
* ã‹ã‚†ã„æ‰€ã«æ‰‹ãŒå±Šããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
* ã‚„ã‚ŠãŸã„ã“ã¨ãŒè‡ªç„¶ã«ã§ãã‚‹
   * eventã‚’å–ã£ã¦ãã¦RLP decodeã—ãŸã„
   * ãƒ‡ãƒ¼ã‚¿ã‚’solidityã®`keccak`ã¨åŒã˜æ–¹å¼ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ç½²åã—ãŸã„
   * ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®é–¢æ•°ã‚’å‹•çš„ã«å‘¼ã³æ›¿ãˆãŸã„
       * `eth.send(HogeContractFunction.Create, ...hoge.toArgs())`

---
## ethers.jsã‚’ä½¿ã†å‰æã§Web APIã‚‚Go -> TypeScriptã¸
* Ethereumã¯å…¨ä½“çš„ã«jsã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæ•´ã£ã¦ã„ã‚‹ã®ã§ã€NodeJSã‚’ä½¿ã†ã®ã¯æ‚ªã„é¸æŠè‚¢ã§ã¯ãªã•ãã†
   * Goã•ã‚“é ‘å¼µã£ã¦æ¬²ã—ã„
   * _Rustãƒ„ã‚«ã‚¤ã‚¿ã‚¤ãƒŠã€œ_

## è‰²ã€…ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ¡ç”¨ã—ã¦ã„ã‚‹stack
* WebAPI ... TypeScript(express) + TypeORM + ethers.js
* Frontend ... Nuxt.js
* Tools ... dbmate (migration), Ganache CLI, Truffle

---

## ethers.jsã‚’ä½¿ã„å€’ã™ãŸã‚ã®ãƒ„ãƒ¼ãƒ«: buidler.dev
* `@nomiclabs/buidler`
* consoleã‹ã‚‰ã‚‚deployã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ã‚‚ethersã‚’ä½¿ã„ãŸã„ã€œ
* ethers.jsãŒä½¿ãˆã¦TypeScriptãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼(Yet Another Truffle)
* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãªstack traceå‡ºåŠ›
* configãŒTruffleã«æ¯”ã¹ã‚‹ã¨æŸ”è»Ÿ
* `yarn add --dev @nomiclabs/buidler`
    * global installã ã¨TypeScirptã§configãŒæ›¸ã‘ãªã„

---

![](images/buidler_config.png)

---

![bg 95%](images/stack_trace_buidler.png)
![bg 95%](images/stack_trace_truffle.png)

---
## ãã®ä»–æ©Ÿèƒ½ã‚‚ã„ã‚ã„ã‚
* pulginã§ã‚ˆã—ãªã«æ‹¡å¼µã§ãã‚‹
* builder consoleã‹ã‚‰ethers.jsã§ãƒãƒ¼ãƒ‰ã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

--- 

# ãã®ä»–ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«
* indexer
    * Consensysã®å‡ºã—ã¦ã‚‹ã‚„ã¤...
    * Eventeum (by Consensys)
    * the Graph
    * Eth.events
    * https://scrapbox.io/layerx/Ethereum_Indexeræ¯”è¼ƒ ã«è©³ã—ã„
* BaaS
    * Kaleidoã®å‡ºæ¥ãŒãã£ãè‰¯ã„
        * Zether(ç§˜åŒ¿é€é‡‘)
        * Block explorer
* static analysis tools
    * MythX
    * etc...
---

# éª¨ã®æŠ˜ã‚Œã‚‹ï¼ˆæ¥½ã—ã„ï¼‰å®Ÿè£…ãŸã¡ğŸ‘»

---

# ç½²åæ¤œè¨¼ã‚’ç”¨ã„ãŸèªè¨¼
* åŸºæœ¬ã®æµã‚Œ
    * ã‚µãƒ¼ãƒorã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚“ã ãƒãƒƒã‚·ãƒ¥å€¤ã«ç§˜å¯†éµã§ç½²å
        * EIP191
        * EIP1271
    * ã‚µãƒ¼ãƒorã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§æ¤œè¨¼
        * æ¤œè¨¼= ecrecover
    * å®Ÿè£…å‰ã®ãŠæ°—æŒã¡ï¼šã€Œã“ã‚“ãªã‚“ä¸€ç¬ã‚„ã‚ã€
    * å®Ÿéš›ï¼šçµæ§‹å¤§å¤‰
        * å°‘ã—ã§ã‚‚å…¥åŠ›ãŒç•°ãªã‚‹ã¨ãƒãƒƒã‚·ãƒ¥ãŒå¤‰ã‚ã‚‹
        * Solidityã®keccakã«å¯¾å¿œã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®é–¢æ•°isã©ã‚Œ...??
        * `abi.encodePacked`ãªã«ã‚„ã£ã¦ã‚‹ã® ...
        * å‹ã®æŒ‡å®šãŒé›‘ã ã¨RLPã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®é•ã„ã§ãƒãƒƒã‚·ãƒ¥ãŒå¤‰ã‚ã‚‹

    ---
    ![](images/validate_signature.png)


